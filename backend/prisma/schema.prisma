generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                           @id @default(uuid())
  email                    String                           @unique
  passwordHash             String
  role                     Role
  name                     String
  isActive                 Boolean                          @default(true)
  createdAt                DateTime                         @default(now())
  updatedAt                DateTime                         @updatedAt
  createdBy                String?
  commissions              Commission[]
  dispatchesCreatedBy      DispatchOrder[]                  @relation("DispatchCreator")
  dispatchesAsManufacturer DispatchOrder[]                  @relation("DispatchManufacturer")
  grns                     GRN[]
  inventoryTransactions    InventoryTransaction[]
  invoices                 Invoice[]
  manufacturerInventory    ManufacturerInventory[]
  materials                Material[]
  notifications            Notification[]
  productionBatches        ProductionBatch[]
  retailerInventory        RetailerInventory[]
  assignmentsCreated       RetailerManufacturerAssignment[] @relation("AssignmentAdmin")
  manufacturerAssignments  RetailerManufacturerAssignment[] @relation("ManufacturerAssignments")
  retailerAssignments      RetailerManufacturerAssignment[] @relation("RetailerAssignments")
  returnsAsManufacturer    Return[]                         @relation("ReturnManufacturer")
  returnsResolved          Return[]                         @relation("ReturnResolver")
  returnsAsRetailer        Return[]                         @relation("ReturnRetailer")
  sales                    Sale[]
  srnsAsApprover           SRN[]                            @relation("SRNApprover")
  srnsAsRetailer           SRN[]                            @relation("SRNRetailer")
  creator                  User?                            @relation("UserCreator", fields: [createdBy], references: [id])
  createdUsers             User[]                           @relation("UserCreator")

  @@map("users")
}

model RetailerManufacturerAssignment {
  id             String   @id @default(uuid())
  retailerId     String
  manufacturerId String
  assignedAt     DateTime @default(now())
  assignedBy     String
  isActive       Boolean  @default(true)
  admin          User     @relation("AssignmentAdmin", fields: [assignedBy], references: [id])
  manufacturer   User     @relation("ManufacturerAssignments", fields: [manufacturerId], references: [id])
  retailer       User     @relation("RetailerAssignments", fields: [retailerId], references: [id])

  @@unique([retailerId, manufacturerId])
  @@map("retailer_manufacturer_assignments")
}

model Material {
  id                    String                  @id @default(uuid())
  sqCode                String                  @unique
  name                  String
  description           String?
  hsnCode               String
  gstRate               Decimal                 @db.Decimal(5, 2)
  unitsPerPacket        Int
  mrpPerPacket          Decimal                 @db.Decimal(10, 2)
  commissionType        CommissionType
  commissionValue       Decimal                 @db.Decimal(10, 2)
  hasProduction         Boolean                 @default(false)
  isActive              Boolean                 @default(true)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  createdBy             String
  dispatchItems         DispatchItem[]
  grnItems              GRNItem[]
  inventoryTransactions InventoryTransaction[]
  invoiceItems          InvoiceItem[]
  manufacturerInventory ManufacturerInventory[]
  creator               User                    @relation(fields: [createdBy], references: [id])
  productionBatches     ProductionBatch[]
  retailerInventory     RetailerInventory[]
  returnItems           ReturnItem[]
  sales                 Sale[]
  srnItems              SRNItem[]

  @@map("materials")
}

model ProductionBatch {
  id                 String   @id @default(uuid())
  materialId         String
  manufacturerId     String
  batchNumber        String
  manufactureDate    DateTime
  expiryDate         DateTime
  packetsProduced    Int
  looseUnitsProduced Int      @default(0)
  hsnCodeSnapshot    String
  createdAt          DateTime @default(now())
  manufacturer       User     @relation(fields: [manufacturerId], references: [id])
  material           Material @relation(fields: [materialId], references: [id])

  @@unique([manufacturerId, batchNumber])
  @@map("production_batches")
}

model ManufacturerInventory {
  id                String   @id @default(uuid())
  materialId        String
  manufacturerId    String
  fullPackets       Int      @default(0)
  blockedPackets    Int      @default(0)
  looseUnits        Int      @default(0)
  blockedLooseUnits Int      @default(0)
  updatedAt         DateTime @updatedAt
  manufacturer      User     @relation(fields: [manufacturerId], references: [id])
  material          Material @relation(fields: [materialId], references: [id])

  @@unique([materialId, manufacturerId])
  @@map("manufacturer_inventory")
}

model RetailerInventory {
  id          String   @id @default(uuid())
  materialId  String
  retailerId  String
  fullPackets Int      @default(0)
  looseUnits  Int      @default(0)
  updatedAt   DateTime @updatedAt
  material    Material @relation(fields: [materialId], references: [id])
  retailer    User     @relation(fields: [retailerId], references: [id])

  @@unique([materialId, retailerId])
  @@map("retailer_inventory")
}

model SRN {
  id             String         @id @default(uuid())
  srnNumber      String         @unique
  retailerId     String
  manufacturerId String?
  status         SRNStatus      @default(DRAFT)
  createdAt      DateTime       @default(now())
  submittedAt    DateTime?
  approvedAt     DateTime?
  rejectedAt     DateTime?
  approvedBy     String?
  rejectionNote  String?
  dispatchOrder  DispatchOrder?
  items          SRNItem[]
  approver       User?          @relation("SRNApprover", fields: [approvedBy], references: [id])
  retailer       User           @relation("SRNRetailer", fields: [retailerId], references: [id])

  @@map("srns")
}

model SRNItem {
  id                  String   @id @default(uuid())
  srnId               String
  materialId          String
  requestedPackets    Int
  requestedLooseUnits Int      @default(0)
  approvedPackets     Int?
  approvedLooseUnits  Int?
  material            Material @relation(fields: [materialId], references: [id])
  srn                 SRN      @relation(fields: [srnId], references: [id], onDelete: Cascade)

  @@unique([srnId, materialId])
  @@map("srn_items")
}

model DispatchOrder {
  id              String         @id @default(uuid())
  dispatchNumber  String         @unique
  srnId           String         @unique
  manufacturerId  String
  createdBy       String
  status          DispatchStatus @default(PENDING)
  createdAt       DateTime       @default(now())
  executedAt      DateTime?
  deliveryNotes   String?
  totalPackets    Int
  totalLooseUnits Int            @default(0)
  subtotal        Decimal        @db.Decimal(12, 2)
  items           DispatchItem[]
  creator         User           @relation("DispatchCreator", fields: [createdBy], references: [id])
  manufacturer    User           @relation("DispatchManufacturer", fields: [manufacturerId], references: [id])
  srn             SRN            @relation(fields: [srnId], references: [id])
  grn             GRN?

  @@map("dispatch_orders")
}

model DispatchItem {
  id         String        @id @default(uuid())
  dispatchId String
  materialId String
  packets    Int
  looseUnits Int           @default(0)
  unitPrice  Decimal       @db.Decimal(10, 2)
  lineTotal  Decimal       @db.Decimal(12, 2)
  hsnCode    String
  gstRate    Decimal       @db.Decimal(5, 2)
  dispatch   DispatchOrder @relation(fields: [dispatchId], references: [id], onDelete: Cascade)
  material   Material      @relation(fields: [materialId], references: [id])

  @@unique([dispatchId, materialId])
  @@map("dispatch_items")
}

model GRN {
  id            String        @id @default(uuid())
  grnNumber     String        @unique
  dispatchId    String        @unique
  retailerId    String
  status        GRNStatus     @default(PENDING)
  createdAt     DateTime      @default(now())
  confirmedAt   DateTime?
  notes         String?
  items         GRNItem[]
  dispatchOrder DispatchOrder @relation(fields: [dispatchId], references: [id])
  retailer      User          @relation(fields: [retailerId], references: [id])
  invoice       Invoice?
  returns       Return[]

  @@map("grns")
}

model GRNItem {
  id                 String   @id @default(uuid())
  grnId              String
  materialId         String
  expectedPackets    Int
  expectedLooseUnits Int      @default(0)
  receivedPackets    Int?
  receivedLooseUnits Int?
  grn                GRN      @relation(fields: [grnId], references: [id], onDelete: Cascade)
  material           Material @relation(fields: [materialId], references: [id])

  @@unique([grnId, materialId])
  @@map("grn_items")
}

model Return {
  id              String       @id @default(uuid())
  returnNumber    String       @unique
  retailerId      String
  manufacturerId  String
  grnId           String?
  status          ReturnStatus @default(RAISED)
  reason          ReturnReason
  reasonDetails   String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionNotes String?
  items           ReturnItem[]
  grn             GRN?         @relation(fields: [grnId], references: [id])
  manufacturer    User         @relation("ReturnManufacturer", fields: [manufacturerId], references: [id])
  resolver        User?        @relation("ReturnResolver", fields: [resolvedBy], references: [id])
  retailer        User         @relation("ReturnRetailer", fields: [retailerId], references: [id])

  @@map("returns")
}

model ReturnItem {
  id         String   @id @default(uuid())
  returnId   String
  materialId String
  packets    Int      @default(0)
  looseUnits Int      @default(0)
  material   Material @relation(fields: [materialId], references: [id])
  return     Return   @relation(fields: [returnId], references: [id], onDelete: Cascade)

  @@unique([returnId, materialId])
  @@map("return_items")
}

model Notification {
  id          String           @id @default(uuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  referenceId String?
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())
  user        User             @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  grnId         String        @unique
  retailerId    String
  createdBy     String
  createdAt     DateTime      @default(now())
  subtotal      Decimal       @db.Decimal(12, 2)
  cgst          Decimal?      @db.Decimal(12, 2)
  sgst          Decimal?      @db.Decimal(12, 2)
  igst          Decimal?      @db.Decimal(12, 2)
  totalAmount   Decimal       @db.Decimal(12, 2)
  isInterstate  Boolean       @default(false)
  items         InvoiceItem[]
  grn           GRN           @relation(fields: [grnId], references: [id])
  retailer      User          @relation(fields: [retailerId], references: [id])

  @@map("invoices")
}

model InvoiceItem {
  id             String   @id @default(uuid())
  invoiceId      String
  materialId     String
  materialName   String
  hsnCode        String
  gstRate        Decimal  @db.Decimal(5, 2)
  packets        Int
  looseUnits     Int      @default(0)
  unitsPerPacket Int
  unitPrice      Decimal  @db.Decimal(10, 2)
  lineTotal      Decimal  @db.Decimal(12, 2)
  invoice        Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  material       Material @relation(fields: [materialId], references: [id])

  @@map("invoice_items")
}

model Sale {
  id            String      @id @default(uuid())
  saleNumber    String      @unique
  retailerId    String
  materialId    String
  unitsSold     Int
  unitPrice     Decimal     @db.Decimal(10, 2)
  totalAmount   Decimal     @db.Decimal(12, 2)
  packetsOpened Int         @default(0)
  createdAt     DateTime    @default(now())
  commission    Commission?
  material      Material    @relation(fields: [materialId], references: [id])
  retailer      User        @relation(fields: [retailerId], references: [id])

  @@map("sales")
}

model Commission {
  id             String           @id @default(uuid())
  saleId         String           @unique
  retailerId     String
  commissionType CommissionType
  commissionRate Decimal          @db.Decimal(10, 2)
  unitsSold      Int
  amount         Decimal          @db.Decimal(12, 2)
  status         CommissionStatus @default(PENDING)
  createdAt      DateTime         @default(now())
  paidAt         DateTime?
  retailer       User             @relation(fields: [retailerId], references: [id])
  sale           Sale             @relation(fields: [saleId], references: [id])

  @@map("commissions")
}

model InventoryTransaction {
  id                String          @id @default(uuid())
  materialId        String
  userId            String
  transactionType   TransactionType
  locationType      String
  locationId        String
  packetsChange     Int
  unitsChange       Int             @default(0)
  referenceType     String
  referenceId       String
  packetsAfter      Int
  unitsAfter        Int             @default(0)
  blockedAfter      Int             @default(0)
  blockedUnitsAfter Int             @default(0)
  notes             String?
  createdAt         DateTime        @default(now())
  material          Material        @relation(fields: [materialId], references: [id])
  user              User            @relation(fields: [userId], references: [id])

  @@map("inventory_transactions")
}

model SequenceCounter {
  id           String @id
  prefix       String
  currentValue Int    @default(0)

  @@map("sequence_counters")
}

enum Role {
  ADMIN
  MANUFACTURER
  RETAILER
}

enum SRNStatus {
  DRAFT
  SUBMITTED
  APPROVED
  PARTIAL
  REJECTED
}

enum DispatchStatus {
  PENDING
  IN_TRANSIT
  DELIVERED
}

enum GRNStatus {
  PENDING
  CONFIRMED
  DISPUTED
}

enum CommissionType {
  PERCENTAGE
  FLAT_PER_UNIT
}

enum CommissionStatus {
  PENDING
  PAID
}

enum TransactionType {
  PRODUCTION
  DISPATCH_BLOCK
  DISPATCH_EXECUTE
  DISPATCH_UNBLOCK
  GRN_RECEIVE
  SALE
  PACKET_OPEN
  RETURN_RESTOCK
}

enum ReturnReason {
  DAMAGED_GOODS
  MISSING_UNITS
  QUALITY_ISSUE
  WRONG_PRODUCT
  OTHER
}

enum ReturnStatus {
  RAISED
  UNDER_REVIEW
  APPROVED_RESTOCK
  APPROVED_REPLACE
  REJECTED
  RESOLVED
}

enum NotificationType {
  RETURN_RAISED
  RETURN_RESOLVED
  SRN_SUBMITTED
  SRN_APPROVED
  SRN_REJECTED
  DISPATCH_CREATED
  DISPATCH_EXECUTED
  GRN_CONFIRMED
}
